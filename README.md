# MeteoStation (ESP32‑C3 Firmware)

Метеостанция на базе **ESP32‑C3** с датчиком **AHT20** + **BMP280** и фирменным Android‑приложением.

Этот репозиторий предназначен **для распространения готовых прошивок (бинарных файлов)** и описания возможностей устройства. Исходный код Android‑приложения и детали его сборки здесь не публикуются.

---

## Возможности станции

- Поддержка двух режимов работы:
  - **BLE (Bluetooth Low Energy)** — начальная настройка и получение метеоданных по BLE.
  - **Wi‑Fi STA (клиент)** — плата подключается к вашему роутеру и отдаёт данные по HTTP.
- Автоопределение датчика на I2C‑шине (**AHT20**, **BMP280**).
- Передача метеоданных в формате **JSON**:
  - по BLE (уведомления характеристики);
  - по HTTP (`/metrics`) в Wi‑Fi режиме.
- Встроенный веб‑сервер:
  - веб‑страница с интерфейсом по адресу `http://<ip_адрес>/`;
  - JSON‑метрики по адресу `http://<ip_адрес>/metrics`.
- Служебные JSON‑сообщения по BLE:
  - статус Wi‑Fi (`wifi_status`);
  - смена режима работы (`mode_changed`).

Android‑приложение подключается к станции, показывает текущие измерения и позволяет настраивать Wi‑Fi **без изменения прошивки**.

---

## Режимы работы

### BLE (Bluetooth Low Energy)

- Станция после прошивки стартует в **BLE‑режиме**.
- ESP32‑C3 рекламируется с именем, например, `MeteoStation`.
- Телефон (через фирменное приложение) находит устройство, подключается по BLE и:
  - получает текущие метеоданные в JSON;
  - может отправлять настройки Wi‑Fi сети на станцию.

### Wi‑Fi STA (клиент)

- После получения настроек Wi‑Fi от телефона станция переключается в режим **Wi‑Fi STA**.
- Подключается к вашему роутеру и получает IP‑адрес.
- По этому IP доступны:
  - веб‑интерфейс: `http://<ip_адрес>/`;
  - метрики в формате JSON: `http://<ip_адрес>/metrics`.
- Статус подключения и IP‑адрес отправляются обратно в приложение по BLE сообщением:

```json
{"type":"wifi_status","status":"ok","ip":"192.168.x.x"}
```

При ошибке подключения отправляется сообщение с `status="error"` и `reason`.

---

## Структура релизов

В разделе **Releases** (или в папке с бинарниками) выкладываются готовые файлы прошивки. 
Для текущей платы ESP32‑C3 (профиль `esp32.esp32.lolin_c3_mini`) используются файлы:

- `meteo_station.ino.bootloader.bin`  — загрузчик (bootloader)
- `meteo_station.ino.partitions.bin`  — таблица разделов (partitions)
- `meteo_station.ino.bin`              — основная прошивка (приложение)
- `meteo_station.ino.merged.bin`       — **комбинированный бинарник**, включающий все вышеперечисленные части

В релизах можно публиковать как отдельные файлы, так и только комбинированный `meteo_station.ino.merged.bin` — в зависимости от того, как удобнее пользователям.

---

## Прошивка готового бинарника

> ВНИМАНИЕ: все действия по прошивке вы выполняете на свой страх и риск. Убедитесь, что выбираете правильный порт и модель платы.

Для прошивки ESP32‑C3 вы можете использовать:

- Официальную утилиту **ESP32 Flash Download Tool** (GUI от Espressif).
- Или консольную утилиту **esptool.py**.

### Вариант 1: ESP32 Flash Download Tool (GUI)

1. Скачайте "ESP32 Flash Download Tool" с сайта Espressif:

   <https://docs.espressif.com/projects/esp-test-tools/en/latest/esp32/production_stage/tools/flash_download_tool.html>

   Или используйте архив `flash_download_tool.zip`, приложенный в этом репозитории.
2. Подключите плату ESP32‑C3 к ПК по USB.
3. Переведите плату в режим загрузки (Boot/EN — см. документацию на вашу плату).
4. В утилите выберите нужный чип (**ESP32‑C3**).
5. Укажите бинарные файлы и адреса, используя файлы из релиза. Для типичной конфигурации можно использовать:
   - `meteo_station.ino.bootloader.bin` → `0x0000`
   - `meteo_station.ino.partitions.bin` → `0x8000`
   - `meteo_station.ino.bin` → `0x10000`
6. Выберите COM‑порт вашей платы.
7. Нажмите **START** и дождитесь окончания прошивки.

Точные адреса и состав бинарников обязательно сверяйте с описанием конкретного релиза — они могут отличаться.



#### 1.2. Прошивка комбинированного бинарника

Если в релизе есть файл `meteo_station.ino.merged.bin`, он уже содержит bootloader, partitions и основную прошивку, собранные вместе. 
В этом случае достаточно прошить **один файл** с адреса `0x0`:

- Убедитесь, что используете именно `meteo_station.ino.merged.bin` из соответствующего релиза.

---

## Протокол обмена (кратко)

### BLE JSON сообщения

- **Метеоданные** — периодические уведомления с температурой, влажностью, давлением, высотой.
- **Статус Wi‑Fi**:

```json
{"type":"wifi_status","status":"ok","ip":"192.168.x.x"}
{"type":"wifi_status","status":"error","reason":"wrong_password"}
```

- **Смена режима**:

```json
{"type":"mode_changed","mode":"BLE"}
{"type":"mode_changed","mode":"STA"}
```

### HTTP интерфейс

- Веб‑страница: `http://<ip_адрес>/`
- Метрики: `http://<ip_адрес>/metrics` (JSON)

---

## Логи и производительность

- В прошивке отключён лишний отладочный вывод в Serial.
- В логах остаются только данные, полезные для пользователя:
  - метео‑JSON;
  - ответы на команды;
  - ключевые сообщения о состоянии.

Это уменьшает нагрузку на порт и упрощает анализ работы станции.

---

## Android‑приложение

Для работы с метеостанцией используется отдельное Android‑приложение:

- Подключение к станции по BLE.
- Настройка Wi‑Fi сети для режима STA.
- Переключение режимов BLE / Wi‑Fi.
- Отображение текущих метеоданных.

Приложение распространяется отдельно (через Google Play) и в этом репозитории **не собирается и не публикуется в исходниках**.

---

## Лицензия

Прошивки и сопутствующие бинарные файлы в этом репозитории предоставляются
исключительно для личного, некоммерческого использования.

Разрешается:

- использовать прошивки на своих устройствах в личных целях;
- модифицировать прошивки для личного использования;
- делиться неизменёнными бинарными файлами с другими пользователями, также только для личного использования.

Запрещается без предварительного письменного разрешения правообладателя:

- использовать прошивки или их модификации в коммерческих продуктах и услугах;
- продавать прошивки (как отдельно, так и в составе устройств);
- включать прошивки в состав любых платных решений или предложений.

Все права на прошивки и связанные материалы сохраняются за автором проекта.
